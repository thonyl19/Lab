@{
	ViewBag.Title = @Genesis.Common.PageBaseInfo.getCurrentResource("UI 規範041").RESOURCE_NAME;
	bool isSingleModel = (bool)ViewData["SingleModel"];
	if (isSingleModel) Layout = "~/Views/Shared/_LayoutSingle.cshtml";

}
@eBundle.QRender_CSS()
@eBundle.QRender_JS()
@Html.Partial("~/Areas/MES/Views/Shared/_wo_condition.cshtml")
<h3>
	@ViewBag.Title
	<small><a href="https://genesisoffice365.sharepoint.com/:o:/r/sites/GTiMES50/_layouts/15/WopiFrame.aspx?sourcedoc={7175ca3d-ef9b-447d-a677-837671fc502f}&action=edit&wd=target%28UI%2Eone%7C0DA210C6%2DA155%2D4147%2DABA6%2DF995FD827BC6%2F%E8%A1%A8%E6%A0%BC%2D%E8%A4%87%E5%90%88%E6%A2%9D%E4%BB%B6%E6%9F%A5%E8%A9%A2%2C%E6%8E%92%E5%BA%8F%2C%E6%8F%9B%E9%A0%81%7C52285BEF%2D5F20%2D499D%2D8F2D%2D25FCB63DC876%2F%29onenote%3Ahttps%3A%2F%2Fgenesisoffice365%2Esharepoint%2Ecom%2Fsites%2FGTiMES50%2FSiteAssets%2FGTiMES%205%2E0%20%E9%96%8B%E7%99%BC%20%E7%AD%86%E8%A8%98%E6%9C%AC%2FUI%2Eone#%E8%A1%A8%E6%A0%BC-%E8%A4%87%E5%90%88%E6%A2%9D%E4%BB%B6%E6%9F%A5%E8%A9%A2,%E6%8E%92%E5%BA%8F,%E6%8F%9B%E9%A0%81&section-id={0DA210C6-A155-4147-ABA6-F995FD827BC6}&page-id={52285BEF-5F20-499D-8F2D-25FCB63DC876}&end" target="_blank">參考文件</a></small>
</h3>
<div id="app" v-cloak>
	<gt-toolbar :e_query="click_Query">

	</gt-toolbar>
	{{Code}}
	<div Area-Main class="panel b pt-lg ">
		<gt-searchcd active_names="1">
			<gti-wo-contion ref="wo_cd" v-model="form"></gti-wo-contion>
		</gt-searchcd>
		@Html.Partial("UI_SPEC_041_Grid")
	</div>
</div>

<script>
	$(() => {
		new Vue({
			el: '#app',
			data() {
				return {
					grid: {
						data: [],
						pageSize: 10,
						pageIdx: 1,
						row_count: 0,
						Sort: {
							Name: "CREATE_DATE",
							isAsc: true
						},
						Conditions: {},
						Page: {
							Index: 1,
							Size: 10,
						},
						get query_rule() {
							{
								let { Conditions, Sort, Page } = this;
								return {
									Conditions, Sort, Page
								}
							}
						}
					},

					form: {
						WO: '',
						STATUS: '',
						WO_LINE_SID: '',
						PRIORITY: '',
						PARTNO: '',
						ROUTE: '',
					},
					i18n: {
						清除條件: '清除條件',
						品號: '@RES.BLL.Face.PartNo',
						品名: '@RES.BLL.Face.PartName',
					},
					Code: null,
				}
			},
			methods: {
				//#region [Grid 相關程序]
				//排序事件
				sort_change(column) {
					this.grid.Sort = {
						Name: column.prop,
						isAsc: column.order == "ascending"
					}
					if (this.grid.data.length == 0) return;
					this.query(1);
				},
				e_SizeChange: function (size) {
					this.pagesize = size;
					this.query(1);
				},
				// 換頁事件
				e_CurrentChange: function (currentPage) {
					this.query(currentPage);
				},
				// 子視窗查詢程序
				act_WO(WO) {
					//debugger
					var arg = {
						title: '@RES.BLL.Face.WorderInfo',
						content: `@Url.Action("single")?name=UI_SPEC_041_Form`
					}
					this.$UT.layer(arg, this);
				},
				//父視窗reload 功能
				reload() {
					console.log("父視窗reload!!");
					this.query(this.grid.Page.Index);
				},
				//查詢事件
				click_Query() {
					this.grid.Conditions = this.$refs.wo_cd.get_Conditions();
					/*
					//此段程序就是 wo_cd.get_Conditions 內做的事,沒有既有控制件可用的話,就請用以下的 code 改寫
					var Conditions = {
						condition: "AND",
						rules: [
						]
					};
					//equal
					//{ field: 'STATUS', type: "string", operator: "in", value: ["Release", "Create"] }
					_.each(this.form, (value, field) => {
						if (value != "") {
							var _rule = { field, type: "string", operator: "in", value };
							if (_.isString(value)) {
								_rule.operator = "equal";
								_rule.value = [value];
							}
							Conditions.rules.push(_rule);
						}
					});
					this.grid.Conditions = Conditions;
					 */
					this.query(1);
				},
				// 查詢處理程序
				query(pageIdx) {
					var _self = this;
					_self.grid.Page.Index = pageIdx;
					var param = _self.grid.query_rule;

					var _ajax = {
						url: '@Url.Action("WO_Query")',
						type: 'post',
						param,
						success: this.query_success
					};
					$.submitForm(_ajax);
				},
				// 查詢成功處理程序
				query_success(res) {
					debugger
					let { Data, Code = null, Message, Success = false } = res;
					if (Success) {
						let { PageInfo, Queryable } = Data || {};
						this.grid.data = Queryable;
						this.grid.row_count = PageInfo.RowCount;
					} else {
						var msg = Message != null
							? Message
							: '@BLL.InterFace.ErrCode.GenericErrorMessage'
							;
						this.$Alert.Err(msg);
					}
				}
				//#endregion 

			}
		})
	});
</script>
